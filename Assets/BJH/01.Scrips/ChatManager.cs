using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.EventSystems;
using Photon.Chat;
using ExitGames.Client.Photon;
using Photon.Pun;
using Photon.Realtime;
using UnityEngine.Networking;
using System;
using TMPro;

public class ChatBotResponse
{
    public string answer;
    public string task;
    public string data;
    public string island_id;
}

public class ChatManager : MonoBehaviourPun, IPointerDownHandler, IChatClientListener
{
    // chat
    public GameObject chatBG, yellow, white, black, date;
    public RectTransform rtContent;
    public TMP_InputField chatInput;
    public Scrollbar scrollbar;

    // chat rooms
    public List<string> chatChannelNames;

    // Photon Chat
    ChatAppSettings chatAppSettings;
    ChatClient chatClient;


    PlayerMove clickMove;

    // bool
    bool isChatRoomActive = false;

    public GameObject message;



    // 애니메이션
    public GameObject particle;
    public Transform TrParticle;
    public GameObject createdParticle;
    public Transform kkamang;
    public Animator chatJump;

    private string url = "http://221.163.19.218:1221/api";


    // 프로필
    // 모든 플레이어의 key : 닉네임, value : 캐릭터 이름
    public Dictionary<string, string> dicAllPlayerProfile = new Dictionary<string, string>();

    // instance를 사용해서 chat client를 사용한다.
    private static ChatManager instance;

    private void Awake()
    {
        if(instance == null)
        {
            instance = this;
        }
    }

    public static ChatManager Instance
    {
        get
        {
            return instance;
        }
    }



    void Start()
    {
        isChatRoomActive = false;
        // alert.SetActive(false);
        chatBG.SetActive(false);

        // 텍스트를 작성하고 엔터를 쳤을때 호출되는 함수 등록
        chatInput.onSubmit.AddListener(OnSubmit);

        // photon chat 초기 설정
        PhotonChatSetting();

        // 초기 설정을 바탕으로 photon chat 입장
        Connect();
    }

    // Update is called once per frame
    void Update()
    {
        if (chatClient != null)
        {
            chatClient.Service();
        }

        // 테스트
        if(Input.GetKeyDown(KeyCode.Keypad4))
        {
            print("button4");
            StartCoroutine("CoKkamangMessageDelay");
        }
    }

    // 채팅창에서 엔터를 누르면 실행되는 함수

    void OnSubmit(string text)
    {
        if(text.Length == 0)
        {
            return;
        }

        // chatInput에 받아온 text를 photon chat을 사용해서 전송
        chatInput.text = text;

        chatClient.PublishMessage(chatChannelNames[0], text);

        // chatInput 내용 초기화
        chatInput.text = "";

        // chatInput 강제로 선택된 상태로
        chatInput.ActivateInputField();

        if (text.Contains("까망"))
        {
            print("까망이를 호출했습니다.");
            StartCoroutine(CoKkamangWatingMent());
        }

        // ---------------------------------------------------------------------------------

        ChatInfo chatInfo = new ChatInfo();

        string island_id = InfoManager.Instance.FamilyCode;
        string user_id = PhotonNetwork.NickName;

        DateTime currentTime = DateTime.Now;
        string datetiem = currentTime.ToString("yyyy-MM-dd HH:mm:ss");

        chatInfo.island_id = island_id;
        chatInfo.user_id = user_id;
        chatInfo.content = text;
        chatInfo.datetiem = datetiem;

        //Json 형식으로 값이 들어가지게 됨 -> 이쁘게 나오기 위해 true
        string aiJsonData = JsonUtility.ToJson(chatInfo, true);
        print(aiJsonData);

        //AI와 채팅을 한다!
        OnGetPost(aiJsonData);
    }

    IEnumerator CoKkamangWatingMent()
    {
        yield return new WaitForSeconds(1.5f);

        photonView.RPC("PunSendKkamangChat", RpcTarget.All, "잠시만 기다려보라냥!");

    }


    public void OnGetPost(string s)
    {
        string endPoint = "/chatbot/conversation";
        string finalUrl = url + endPoint;

        HttpRequester_LHS requester = new HttpRequester_LHS();

        requester.SetUrl(RequestType.POST, url, false);
        requester.body = s;
        requester.isJson = true;
        requester.isChat = false;

        requester.onComplete = OnGetPostComplete;
        requester.onFailed = OnGetPostFailed;

        HttpManager_LHS.instance.SendRequest(requester);
    }

    public ChatBotResponse chatBotResponse;

    void OnGetPostComplete(DownloadHandler result)
    {
        chatBotResponse = new ChatBotResponse();
        chatBotResponse = JsonUtility.FromJson<ChatBotResponse>(result.text);

        if(chatBotResponse.task == "대기" || chatBotResponse.answer.Length <= 0 || chatBotResponse.answer == "No Response")
        {
            return;
        }

        photonView.RPC(nameof(PunSendKkamangChat), RpcTarget.All, chatBotResponse.answer);
    }

    [PunRPC]
    public void PunSendKkamangChat(string chat)
    {
        GameObject go = Instantiate(black, rtContent.transform);
        StartCoroutine("CoKkamangMessageDelay");

        AreaScript area = go.GetComponent<AreaScript>();

        // 까망 채팅 UI 설정
        area.boxRect.sizeDelta = new Vector2(600, area.boxRect.sizeDelta.y);
        area.textRect.GetComponent<TMP_Text>().text = chat;
        area.userNameText.text = "까망이";
        area.timeText.text = DateTime.Now.ToString("HH:mm");
        Fit(area.boxRect);


        // 두 줄 이상이면 크기를 줄여가면서,
        // 한 줄이 아래로 내려가는 시점 바로 전 크기를 가로에 대입
        float x = area.textRect.sizeDelta.x + 55;
        float y = area.textRect.sizeDelta.y;

        if (y > 49) // 텍스트가 3줄 이상
        {
            for (int i = 0; i < 200; i++)
            {
                area.boxRect.sizeDelta = new Vector2(x - i * 2, area.boxRect.sizeDelta.y);

                Fit(area.boxRect);

                if (area.boxRect.sizeDelta.x <= 130)
                {
                    print(area.boxRect.sizeDelta.x);
                    break;
                }

                if (y != area.textRect.sizeDelta.y)
                {
                    area.boxRect.sizeDelta = new Vector2(x - (i * 2) + 2, y);
                    break;
                }
            }
        }
        else
        {
            area.boxRect.sizeDelta = new Vector2(x, y);
        }

        Invoke("ScrollDelay", 0.03f);
        SoundManager_LHS.instance.PlaySFX(SoundManager_LHS.ESfx.SFX_LodingCat);
        createdParticle = Instantiate(particle, TrParticle.position, TrParticle.rotation);
        chatJump.SetTrigger("ChatJump");
        Invoke("StopAnimation", 3f);
    }

    void StopAnimation()
    {
        chatJump.SetTrigger("StopJump");
        Destroy(createdParticle);
        print("점프 멈춰");

    }

    IEnumerator CoKkamangMessageDelay()
    {
        message.SetActive(true);

        yield return new WaitForSeconds(0.8f);

        message.SetActive(false);
    }

    void OnGetPostFailed(DownloadHandler result)
    {
        print("Chat 실패");
    }


    public void OnClickSendBtn()
    {
        SoundManager_LHS.instance.PlaySFX(SoundManager_LHS.ESfx.SFX_BUTTONON);

        if(chatInput.text.Length == 0)
        {
            return;
        }

        string text = chatInput.text;

        chatClient.PublishMessage(chatChannelNames[0], text);
        SoundManager_LHS.instance.PlaySFX(SoundManager_LHS.ESfx.SFX_BtnAdd);

        chatInput.text = "";
        chatInput.ActivateInputField();

        if (text.Contains("까망"))
        {
            StartCoroutine(CoKkamangWatingMent());
        }

        // ---------------------------------------------------------------------------------

        ChatInfo chatInfo = new ChatInfo();

        string island_id = InfoManager.Instance.FamilyCode;
        string user_id = PhotonNetwork.NickName;

        DateTime currentTime = DateTime.Now;
        string datetiem = currentTime.ToString("yyyy-MM-dd HH:mm:ss");

        chatInfo.island_id = island_id;
        chatInfo.user_id = user_id;
        chatInfo.content = text;
        chatInfo.datetiem = datetiem;

        string aiJsonData = JsonUtility.ToJson(chatInfo, true);

        OnGetPost(aiJsonData);
    }

    // 포톤 초기 설정
    void PhotonChatSetting()
    {
        //포톤 설정을 가져와서 ChatAppSettings 에 설정하자.
        AppSettings photonSettings = PhotonNetwork.PhotonServerSettings.AppSettings;

        // 위 설정을 가지고 ChatAppSettings 셋팅
        chatAppSettings = new ChatAppSettings();
        chatAppSettings.AppIdChat = photonSettings.AppIdChat;
        chatAppSettings.AppVersion = photonSettings.AppVersion;
        chatAppSettings.FixedRegion = photonSettings.FixedRegion;
        chatAppSettings.NetworkLogging = photonSettings.NetworkLogging;
        chatAppSettings.Protocol = photonSettings.Protocol;
        chatAppSettings.EnableProtocolFallback = photonSettings.EnableProtocolFallback;
        chatAppSettings.Server = photonSettings.Server;
        chatAppSettings.Port = (ushort)photonSettings.Port;
        chatAppSettings.ProxyServer = photonSettings.ProxyServer;
    }
    
    // 설정을 토대로 연결
    void Connect()
    {
        chatClient = new ChatClient(this);

        // 채팅할 때 NickName 설정
        chatClient.AuthValues = new Photon.Chat.AuthenticationValues(PhotonNetwork.NickName);

        // 초기설정을 이용해서 채팅서버에 연결 시도
        chatClient.ConnectUsingSettings(chatAppSettings);
    }

    void CreateChat(string sender, string text, Color color)
    {
        GameObject go;
        AreaScript area;

        if (sender == PhotonNetwork.NickName)
        {
            go = Instantiate(yellow, rtContent);
            area = go.GetComponent<AreaScript>();
        }
        else
        {
            go = Instantiate(white, rtContent);
            area = go.GetComponent<AreaScript>();
            area.userNameText.text = sender;

            // 상대 프로필 이미지 로드하기
            area.profileImg.sprite = Resources.Load<Sprite>("member/" + dicAllPlayerProfile[sender]);
        }

        area.boxRect.sizeDelta = new Vector2(600, area.boxRect.sizeDelta.y);
        area.textRect.GetComponent<TMP_Text>().text = text;
        Fit(area.boxRect);

        float x = area.textRect.sizeDelta.x + 70;
        float y = area.textRect.sizeDelta.y;

        if (y > 49) // 텍스트가 3줄 이상
        {
            for (int i = 0; i < 200; i++)
            {
                area.boxRect.sizeDelta = new Vector2(x - i * 2, area.boxRect.sizeDelta.y);

                Fit(area.boxRect);

                if (area.boxRect.sizeDelta.x <= 130)
                {
                    break;
                }

                if (y != area.textRect.sizeDelta.y)
                {
                    area.boxRect.sizeDelta = new Vector2(x - (i * 2) + 2, y);
                    break;
                }
            }
        }
        else
        {
            area.boxRect.sizeDelta = new Vector2(x, y);
        }

        area.timeText.text = DateTime.Now.ToString("HH:mm");
        Invoke("ScrollDelay", 0.03f);
    }
    void ScrollDelay() => scrollbar.value = 0;



    // 강제로 채팅박스 조정
    void Fit(RectTransform rect) => LayoutRebuilder.ForceRebuildLayoutImmediate(rect);



    public void OnclickCloseBtn()
    {
        isChatRoomActive = false;
        chatBG.SetActive(false);
    }

    public void OnClickChatBtn()
    {
        isChatRoomActive = true;
        chatBG.SetActive(true);

    }


#if PC
    //public void OnClickChatBtn()
    //{
    //    if(isChatRoomActive) // true일 때 누르면? 즉, 채팅룸이 꺼지면
    //    {
    //        //clickMove.canMove = true;

    //        isChatRoomActive = false;
    //        chatScrollView.SetActive(isChatRoomActive);

    //        isChatExcept = false;
    //        chatExcept.SetActive(isChatExcept);
    //    }

    //    else if(!isChatRoomActive) // false일 때 누르면? 즉, 채팅룸이 켜지면
    //    {
    //        //clickMove.canMove = false;

    //        isChatRoomActive = true;
    //        chatScrollView.SetActive(isChatRoomActive);

    //        isChatExcept = true;
    //        chatExcept.SetActive(isChatExcept);
    //    }
    //}

    //// chatRoom이 실행되는 중에
    //// 배경을 클릭하면 chatRoom이 비활성화된다.
    //private void OnMouseDown()
    //{
    //    if (isChatRoomActive)
    //    {
    //        isChatRoomActive = false;
    //        chatScrollView.SetActive(isChatRoomActive);

    //        isChatExcept = false;
    //        chatExcept.SetActive(isChatExcept);
    //    }
    //}
#endif

    public void OnPointerDown(PointerEventData eventData)
    {
        //    // 채팅룸이 열려있는 상태에서 빈 ui를 선택하면 채팅룸이 사라진다.
        //    if(isChatRoomActive == true && EventSystem.current.IsPointerOverGameObject(eventData.pointerId)) {
        //        chatScrollView.SetActive(false);
        //        isChatRoomActive = false;
        //    }
    }


public void DebugReturn(DebugLevel level, string message)
    {
    }

    public void OnDisconnected()
    {
    }

    public void OnConnected()
    {
        print("**** 채팅 서버 접속 성공 ****");
        // 채널 추가
        if (chatChannelNames.Count > 0)
        {
            chatClient.Subscribe(chatChannelNames.ToArray());
        }

        // 나의 상태를 온라인으로 한다.
        chatClient.SetOnlineStatus(ChatUserStatus.Online);
    }

    public void OnChatStateChange(ChatState state)
    {
    }

    public void OnGetMessages(string channelName, string[] senders, object[] messages)
    {
        SoundManager_LHS.instance.PlaySFX(SoundManager_LHS.ESfx.SFX_BUTTONOFF);
        for (int i = 0; i < senders.Length; i++)
        {
            print(nameof(OnGetMessages));
            CreateChat(senders[i], messages[i].ToString(), Color.black);
        }
    }

    public void OnPrivateMessage(string sender, object message, string channelName)
    {
    }

    public void OnSubscribed(string[] channels, bool[] results)
    {
        for (int i = 0; i < channels.Length; i++)
        {
            print("**** 채널 [" + channels[i] + "] 추가 성공");
        }
    }

    public void OnUnsubscribed(string[] channels)
    {
    }

    public void OnStatusUpdate(string user, int status, bool gotMessage, object message)
    {
    }

    public void OnUserSubscribed(string channel, string user)
    {
    }

    public void OnUserUnsubscribed(string channel, string user)
    {
    }

    // scroll view에 chatitem이 많아지면 자동으로 스크롤을 최신 chat으로 내려준다.
    //public RectTransform scrollView;
    //public RectTransform rtContent;
    //IEnumerator AutoScrollBottom()
    //{
    //    yield return 0;


    //    // 만약 chat item이 scroll view보다 커지면
    //    if (rtContent.sizeDelta.y > scrollView.sizeDelta.y)
    //    {
    //        // 마지막으로 전송된 채팅이 scroll view 바닥에 닿았다면?
    //        if (prevContentH - scrollView.sizeDelta.y <= scrollView.anchoredPosition.y) // position : 3D세상의 피봇 위치, anchoredPosition이 실제 인스펙터 창에 나오는 x, y값이 들어있음
    //        {
    //            // content의 y값을 재설정한다.
    //            rtContent.anchoredPosition = new Vector2(0, rtContent.sizeDelta.y - scrollView.sizeDelta.y);
    //        }

    //        // content의 y값을 새로 전송된 채팅의 y값만큼 증가시킨다.
    //    }
    //}
}
